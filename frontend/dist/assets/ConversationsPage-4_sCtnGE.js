var e=Object.defineProperty,t=(t,s,r)=>((t,s,r)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[s]=r)(t,"symbol"!=typeof s?s+"":s,r);import{r as s,j as r}from"./vendor-react-DUoQhEpM.js";import{b as n,i as c,h as o,L as a,c as i}from"./index-BW9YzSHm.js";import{a as l,u}from"./vendor-query-CC2jgEBg.js";import{l as d}from"./vendor-socket-BdCbhlCK.js";import{d as m,S as h,m as x}from"./vendor-icons-KwL3JnsX.js";import{f as b}from"./vendor-date-B0vwdYvA.js";import"./vendor-router-Cg48UhP-.js";import"./vendor-http-B5K7MVzt.js";import"./vendor-B7sF_03a.js";function f(e){const t=void 0;return l({queryKey:["conversations",t],queryFn:async()=>{try{return(await n.list(t)).data}catch(e){throw c(e)&&o(e,"Failed to fetch conversations"),e}},staleTime:1e4})}const g={url:"ws://localhost:8000",path:"/ws",transports:["websocket","polling"],reconnection:!0,reconnectionAttempts:5,reconnectionDelay:1e3};const p=new class{constructor(e={}){t(this,"socket",null),t(this,"subscribers",new Map),t(this,"config"),t(this,"connectionState","disconnected"),t(this,"subscribedRooms",new Set),this.config={...g,...e}}getConnectionState(){return this.connectionState}connect(){var e;(null==(e=this.socket)?void 0:e.connected)||(this.connectionState="connecting",this.socket=d(this.config.url,{path:this.config.path,transports:this.config.transports,reconnection:this.config.reconnection,reconnectionAttempts:this.config.reconnectionAttempts,reconnectionDelay:this.config.reconnectionDelay,withCredentials:!0}),this.setupEventHandlers())}disconnect(){var e;this.subscribers.clear(),this.subscribedRooms.clear(),null==(e=this.socket)||e.disconnect(),this.socket=null,this.connectionState="disconnected"}isConnected(){var e;return(null==(e=this.socket)?void 0:e.connected)??!1}subscribe(e,t){this.subscribers.has(e)||this.subscribers.set(e,new Set);const s=this.subscribers.get(e),r=t;return s.add(r),()=>{s.delete(r),0===s.size&&this.subscribers.delete(e)}}subscribeToRoom(e){var t;(null==(t=this.socket)?void 0:t.connected)&&(this.socket.emit("subscribe",{room:e}),this.subscribedRooms.add(e))}unsubscribeFromRoom(e){var t;(null==(t=this.socket)?void 0:t.connected)&&(this.socket.emit("unsubscribe",{room:e}),this.subscribedRooms.delete(e))}emit(e,t){var s;null==(s=this.socket)||s.emit(e,t)}setupEventHandlers(){this.socket&&(this.socket.on("connect",()=>{this.connectionState="connected",this.subscribedRooms.forEach(e=>{var t;null==(t=this.socket)||t.emit("subscribe",{room:e})})}),this.socket.on("disconnect",()=>{this.connectionState="disconnected"}),this.socket.on("connect_error",e=>{this.connectionState="error"}),this.socket.on("error",e=>{}),this.socket.onAny((e,t)=>{const s=this.subscribers.get(e);s&&s.forEach(e=>{try{e(t)}catch(s){}})}))}getSubscribedRooms(){return Array.from(this.subscribedRooms)}getSubscriberCount(e){var t;return(null==(t=this.subscribers.get(e))?void 0:t.size)??0}};function v(e){try{return b(new Date(e),{addSuffix:!0})}catch{return"Unknown time"}}function y({selectedId:e,onSelect:t}){const{data:n,isLoading:c,error:o}=f(),[l,u]=s.useState(""),d=s.useMemo(()=>{if(!n)return[];if(!l.trim())return n;const e=l.toLowerCase();return n.filter(t=>t.id.toLowerCase().includes(e)||t.status.toLowerCase().includes(e))},[n,l]),b=s.useCallback(e=>{t(e)},[t]);return c?r.jsx("div",{className:"flex h-64 items-center justify-center",children:r.jsx(a,{text:"Loading conversations..."})}):o?r.jsxs("div",{className:"flex h-64 flex-col items-center justify-center p-4 text-center",children:[r.jsx(m,{className:"mb-2 h-8 w-8 text-red-400"}),r.jsx("p",{className:"text-sm text-red-600",children:"Failed to load conversations"}),r.jsx("p",{className:"mt-1 text-xs text-gray-500",children:o.message})]}):r.jsxs("div",{className:"flex h-full flex-col border-r bg-gray-50",children:[r.jsxs("div",{className:"border-b bg-white p-4",children:[r.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Conversations"}),r.jsxs("p",{className:"text-sm text-gray-500",children:[(null==n?void 0:n.length)??0," active threads"]}),r.jsxs("div",{className:"mt-3 relative",children:[r.jsx(h,{className:"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-gray-600","aria-hidden":"true"}),r.jsx("input",{type:"text",placeholder:"Filter conversations...",value:l,onChange:e=>u(e.target.value),className:"w-full rounded-md border border-gray-200 py-2 pl-9 pr-3 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"})]})]}),r.jsxs("div",{className:"flex-1 overflow-y-auto",children:[d.map(t=>r.jsx("button",{onClick:()=>b(t),className:i("w-full border-b p-4 text-left transition-colors hover:bg-gray-100",e===t.id&&"bg-blue-50 hover:bg-blue-100"),children:r.jsxs("div",{className:"flex items-start gap-3",children:[r.jsx("div",{className:"rounded-full bg-gray-200 p-2",children:r.jsx(m,{className:"h-4 w-4 text-gray-600"})}),r.jsxs("div",{className:"min-w-0 flex-1",children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsxs("h3",{className:"truncate font-medium text-gray-900",children:["Conversation ",t.id.slice(0,8),"..."]}),r.jsx("span",{className:"shrink-0 text-xs text-gray-600",children:v(t.created_at)})]}),r.jsxs("div",{className:"mt-1 flex items-center gap-2 text-sm text-gray-500",children:[r.jsx(x,{className:"h-3 w-3"}),r.jsxs("span",{children:[t.message_count," messages"]}),r.jsx("span",{className:i("rounded-full px-2 py-0.5 text-xs","active"===t.status&&"bg-green-100 text-green-800","completed"===t.status&&"bg-gray-200 text-gray-700","error"===t.status&&"bg-red-100 text-red-800"),children:t.status})]})]})]})},t.id)),0===d.length&&r.jsxs("div",{className:"p-8 text-center text-gray-500",children:[r.jsx(m,{className:"mx-auto mb-2 h-8 w-8"}),r.jsx("p",{children:l?"No conversations match your filter":"No conversations found"})]})]})]})}const j=s.memo(function({message:e,isCurrentUser:t}){const n="task_assignment"===e.message_type,c="error"===e.message_type,o=s.useMemo(()=>"string"==typeof e.payload?e.payload:JSON.stringify(e.payload,null,2),[e.payload]),a=s.useMemo(()=>{try{return b(new Date(e.created_at),{addSuffix:!0})}catch{return"unknown time"}},[e.created_at]);return r.jsx("div",{className:i("flex w-full",t?"justify-end":"justify-start"),children:r.jsxs("div",{className:i("max-w-[80%] rounded-lg px-4 py-2",t?"bg-blue-500 text-white":"bg-gray-100 text-gray-900",n&&"bg-purple-100 border border-purple-200",c&&"bg-red-100 border border-red-200"),children:["direct"!==e.message_type&&r.jsx("span",{className:"mb-1 block text-[10px] font-medium uppercase tracking-wider opacity-70",children:e.message_type.replace("_"," ")}),r.jsx("div",{className:"text-sm",children:o}),r.jsx("div",{className:i("mt-1 text-right text-[10px] opacity-60",t?"text-blue-100":"text-gray-500"),children:a})]})})});function N({conversationId:e}){const{data:t,isLoading:i,error:d}=function(e){const t=void 0;return l({queryKey:["conversation-messages",e,t],queryFn:async()=>{try{return(await n.getMessages(e,t)).data}catch(d){throw c(d)&&o(d,"Failed to fetch messages"),d}},enabled:!!e,staleTime:1e3})}(e),{subscribeToRoom:m,unsubscribeFromRoom:h,isConnected:x}=function(){const[e,t]=s.useState(!1),[r,n]=s.useState(null),c=s.useRef([]),o=s.useRef(null),a=s.useRef(null),i=s.useRef(0);s.useEffect(()=>{if(!localStorage.getItem("token"))return void t(!1);let e=!0;const s=()=>{try{p.connect(),o.current=setInterval(()=>{if(!e)return;const r=p.isConnected();if(t(r),!r&&i.current<5){i.current+=1;const t=3e3*Math.pow(2,i.current-1);a.current=setTimeout(()=>{e&&s()},t)}else!r&&i.current>=5&&n(new Error("Max reconnection attempts reached"))},1e3)}catch(r){if(!e)return;t(!1),n(r instanceof Error?r:new Error("Connection failed"))}};return s(),()=>{e=!1,o.current&&(clearInterval(o.current),o.current=null),a.current&&(clearTimeout(a.current),a.current=null),c.current.forEach(e=>{try{e()}catch(t){}}),c.current=[]}},[]);const l=s.useCallback((e,t)=>{const s=p.subscribe(e,t);return c.current.push(s),s},[]),u=s.useCallback((e,t)=>(p.subscribeToRoom(e),t?l(`room:${e}`,t):()=>{}),[l]),d=s.useCallback(e=>{p.unsubscribeFromRoom(e)},[]),m=s.useCallback(()=>{p.disconnect(),o.current&&(clearInterval(o.current),o.current=null),a.current&&(clearTimeout(a.current),a.current=null),t(!1)},[]);return{isConnected:e,error:r,subscribe:l,subscribeToRoom:u,unsubscribeFromRoom:d,disconnect:m}}(),b=s.useRef(null),f=u(),g=s.useRef(null),v=s.useCallback(e=>{f.invalidateQueries({queryKey:["conversations",e,"messages"]})},[f]);return s.useEffect(()=>{if(!e||!x)return;const t=`conversation:${e}`,s=m(t,t=>{v(e)});return g.current=s,()=>{g.current&&(g.current(),g.current=null),h(t)}},[e,m,h,x,v]),s.useEffect(()=>{b.current&&(b.current.scrollTop=b.current.scrollHeight)},[t]),i?r.jsx("div",{className:"flex h-full items-center justify-center",children:r.jsx(a,{text:"Loading messages..."})}):d?r.jsxs("div",{className:"flex h-full flex-col items-center justify-center text-red-500",children:[r.jsx("p",{children:"Failed to load messages"}),r.jsx("p",{className:"text-sm text-gray-500",children:d.message}),r.jsx("button",{onClick:()=>v(e),className:"mt-4 rounded-md bg-blue-500 px-4 py-2 text-white hover:bg-blue-600",children:"Retry"})]}):(null==t?void 0:t.length)?r.jsx("div",{ref:b,className:"flex h-full flex-col gap-4 overflow-y-auto p-4",children:t.map(e=>r.jsx(j,{message:e},e.id))}):r.jsxs("div",{className:"flex h-full flex-col items-center justify-center text-gray-600",children:[r.jsx("p",{className:"text-lg",children:"No messages yet"}),r.jsx("p",{className:"text-sm",children:"Start a conversation to see messages here"})]})}function w(){return r.jsxs("div",{className:"flex h-full flex-col items-center justify-center text-gray-600",children:[r.jsx(m,{className:"mb-4 h-16 w-16 opacity-50","aria-hidden":"true"}),r.jsx("p",{className:"text-lg font-medium",children:"Select a conversation"}),r.jsx("p",{className:"text-sm",children:"Choose from the list to view messages"})]})}function k({conversation:e}){return r.jsxs("div",{className:"border-b bg-white p-4",children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsxs("h3",{className:"font-semibold text-gray-900",children:["Conversation ",(s=e.id,`${s.slice(0,8)}...`)]}),r.jsx("span",{className:`rounded-full px-2 py-0.5 text-xs font-medium ${t=e.status,{active:"bg-green-100 text-green-800",completed:"bg-gray-100 text-gray-800",error:"bg-red-100 text-red-800"}[t]??"bg-gray-100 text-gray-800"}`,children:e.status})]}),r.jsxs("p",{className:"mt-1 text-sm text-gray-500",children:[e.message_count," messages",e.root_task_id&&r.jsxs(r.Fragment,{children:[" Â· Linked to task ",e.root_task_id.slice(0,8),"..."]})]})]});var t,s}function C(){const[e,t]=s.useState(null);f();return r.jsxs("div",{className:"flex h-[calc(100vh-140px)] overflow-hidden rounded-lg border bg-white",children:[r.jsx("aside",{className:"w-80 shrink-0",children:r.jsx(y,{selectedId:null==e?void 0:e.id,onSelect:e=>{t(e)}})}),r.jsx("section",{className:"flex flex-1 flex-col",children:e?r.jsxs(r.Fragment,{children:[r.jsx(k,{conversation:e}),r.jsx("div",{className:"flex-1 overflow-hidden",children:r.jsx(N,{conversationId:e.id})})]}):r.jsx(w,{})})]})}j.displayName="MessageBubble";export{C as ConversationsPage,C as default};
